name: Validate Supabase Questions

on:
  push:            { branches: [main] }
  pull_request:    { branches: [main] }
  workflow_dispatch:
  schedule: [ { cron: '0 5 * * *' } ]

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_SERVICE_KEY:  ${{ secrets.SUPABASE_SERVICE_KEY }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      DEEPSEEK_API_KEY:      ${{ secrets.DEEPSEEK_API_KEY }}
      NODE_OPTIONS: "--no-warnings"

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Configurar Node.js e npm
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Usar Node.js 18 LTS, que vem com npm 8+
          cache: 'npm'

      - name: ðŸ“‹ Verificar versÃµes
        run: |
          node -v
          npm -v

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          echo "Limpando cache do npm e package-lock.json antigo (se existir)..."
          npm cache clean --force
          rm -f package-lock.json
          
          echo "Instalando dependÃªncias do package.json..."
          # Usar --legacy-peer-deps para compatibilidade com dependÃªncias mais antigas
          npm install --legacy-peer-deps
          
          echo "Verificando dependÃªncias instaladas:"
          npm list --depth=0 || echo "Falha ao listar dependÃªncias, mas continuando..."

      - name: ðŸ› ï¸ Configurar ambiente para o script
        run: |
          echo "Criando arquivo .env com as variÃ¡veis de ambiente..."
          echo "SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}" > .env
          echo "SUPABASE_ACCESS_TOKEN=${SUPABASE_ACCESS_TOKEN}" >> .env
          echo "DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}" >> .env
          
          echo "Verificando o script de validaÃ§Ã£o..."
          if [ ! -f "scripts/validateQuestions.ts" ]; then
            echo "ERRO CRÃTICO: scripts/validateQuestions.ts nÃ£o encontrado!"
            ls -la .
            ls -la scripts/
            echo "ERRO: Script de validaÃ§Ã£o nÃ£o encontrado." > audit.log
            exit 1
          fi
          echo "Script encontrado. Primeiras linhas:"
          head -n 10 scripts/validateQuestions.ts

      - name: ðŸ§ª Executar validaÃ§Ã£o de questÃµes
        run: |
          echo "Executando script de validaÃ§Ã£o (scripts/validateQuestions.ts)..."
          # Se ts-node estiver listado como dependÃªncia no package.json, npx o usarÃ¡.
          npx ts-node scripts/validateQuestions.ts | tee audit.log
          # Mesmo que o script falhe (exit code != 0), o workflow continuarÃ¡ para capturar o log.
          echo "ExecuÃ§Ã£o do script concluÃ­da (status: $?)."
        continue-on-error: true # Permite que o job continue para upload do log mesmo se o script falhar
        
      - name: ðŸ” Garantir log de diagnÃ³stico
        if: always() # Executar sempre, mesmo se passos anteriores falharem
        run: |
          if [ ! -s audit.log ]; then
            echo "Criando log de diagnÃ³stico bÃ¡sico porque audit.log estÃ¡ vazio ou nÃ£o existe..."
            echo "ValidaÃ§Ã£o executada em $(date)" > audit.log
            echo "VersÃ£o Node: $(node -v)" >> audit.log
            echo "VersÃ£o NPM: $(npm -v)" >> audit.log
            echo "DependÃªncias instaladas (tentativa de listagem):" >> audit.log
            npm list --depth=0 >> audit.log || echo "NÃ£o foi possÃ­vel listar dependÃªncias." >> audit.log
            echo "AVISO: O script de validaÃ§Ã£o nÃ£o gerou output ou falhou antes de gerar audit.log." >> audit.log
          else
            echo "Log de auditoria (audit.log) gerado pelo script ou preenchido anteriormente."
          fi
          echo "ConteÃºdo final do audit.log:"
          cat audit.log

      - name: ðŸ“¤ Upload de artefatos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-log
          path: audit.log
          retention-days: 30